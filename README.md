# ðŸŒ² Social Media App

A forest-themed social media platform where posts are trees, comments are branches, and communities are forests.

## Tech Stack

- **Next.js 15** (React 19)
- **PostgreSQL** (via Docker)
- **Prisma ORM**
- **Material-UI**
- **JWT Authentication**

## Quick Start

### Prerequisites

- Node.js 24.x
- pnpm 10.18.3 (via corepack: `corepack enable`)
- Docker (for local PostgreSQL)

### Local Development

1. **Clone and Install**

   ```bash
   git clone <your-repo>
   cd social-media-app
   pnpm install
   ```

2. **Setup Environment**

   ```bash
   # Create .env file
   cat > .env << EOF
   DATABASE_URL="postgresql://postgres:password@localhost:5432/socialmedia"
   DB_USERNAME=postgres
   DB_PASSWORD=password
   DB_NAME=socialmedia
   JWT_SECRET="your-secret-key-here"
   EOF
   ```

3. **Start Database**

   ```bash
   docker compose up -d
   ```

4. **Initialize Database**

   ```bash
   pnpx prisma db push
   pnpx prisma generate
   ```

5. **Run Development Server**

   ```bash
   pnpm dev
   ```

   Open [http://localhost:3000](http://localhost:3000)

## Production Deployment

### Oracle Cloud (Free Tier)

1. **Setup OCI Instance**

   ```bash
   ssh ubuntu@<OCI_IP>
   curl -o setup-oci.sh https://raw.githubusercontent.com/<YOUR_REPO>/main/scripts/setup-oci.sh
   chmod +x setup-oci.sh
   sudo ./setup-oci.sh
   ```

2. **Configure GitHub Actions**

   Add these secrets to your GitHub repository:
   - `OCI_HOST` - Your OCI instance IP
   - `OCI_USER` - Usually `ubuntu`
   - `OCI_SSH_KEY` - Your SSH private key (entire content including BEGIN/END lines)
   - `DATABASE_URL` - PostgreSQL connection string (generated by setup script)
   - `JWT_SECRET` - JWT secret (generated by setup script)
   - `APP_URL` - **Important:** Format is `http://YOUR_IP` (no port, no trailing slash)

3. **Deploy via CI/CD**

   Push to `main` branch to trigger automatic deployment:

   ```bash
   git add .
   git commit -m "Deploy to production"
   git push origin main
   ```

   The CI/CD pipeline will:
   - Run tests, linting, and type checking
   - Build the Next.js application
   - Package build artifacts (`.next`, `prisma`, etc.) into a tarball
   - Upload and extract artifacts on OCI instance
   - Install dependencies with pnpm 10.18.3
   - Run database migrations
   - Restart the application with PM2
   - Perform internal and external health checks

### Manual Deployment (Alternative)

If you prefer manual deployment:

```bash
# SSH into your OCI instance
ssh ubuntu@<OCI_IP>

# Clone repository
cd /opt/social-media-app
git clone https://github.com/<YOUR_REPO>/social-media-app.git .

# Run deployment script
chmod +x scripts/deploy-oci.sh
./scripts/deploy-oci.sh
```

## Scripts

- `pnpm dev` - Start development server
- `pnpm db:reset` - Reset database and start dev server
- `pnpm db:push` - Push schema changes to database
- `pnpm build` - Build for production
- `pnpm start` - Start production server
- `pnpm test` - Run tests
- `pnpm lint` - Lint code

## Database

View database in browser:

```bash
pnpx prisma studio
```

## Troubleshooting

### "No route to host" Error

If you can't access your app from outside but it works on the server:

```bash
# SSH into your instance
ssh ubuntu@YOUR_IP

# Run the iptables fix script
cd /opt/social-media-app
chmod +x scripts/fix-iptables.sh
./scripts/fix-iptables.sh
```

This reorders iptables rules to ensure HTTP/HTTPS ACCEPT rules come before the REJECT rule.

### Health Check Fails in CI/CD

1. Verify `APP_URL` secret is set correctly (no port, no https)
2. Check OCI Security List allows ports 80 and 443
3. Ensure nginx is running: `sudo systemctl status nginx`
4. Check firewall rules: `sudo iptables -L INPUT -n --line-numbers`

### More Help

See detailed troubleshooting in `scripts/init/OCI_SETUP_GUIDE.md`
