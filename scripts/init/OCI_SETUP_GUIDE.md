# Oracle OCI Instance Creation and Setup Guide

This guide will help you automatically create and set up an OCI instance for your social media application.

## üöÄ Quick Start

### Prerequisites

1. **Oracle Cloud Account** with Always Free tier access
2. **OCI CLI** installed and configured
3. **33+** generated
4. **GitHub Repository** with your social media app

### Step 1: Install OCI CLI

```bash
# Install OCI CLI (choose your platform)
# macOS
brew install oci-cli

# Linux/Windows WSL
bash -c "$(curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/init/install/install.sh)"

# Windows
# Download from: https://github.com/oracle/oci-cli/releases
```

### Step 2: Configure OCI CLI

```bash
# Run the configuration wizard
oci setup config

# You'll need:
# - User OCID (from OCI Console ‚Üí Profile ‚Üí User Settings)
# - Tenancy OCID (from OCI Console ‚Üí Administration ‚Üí Tenancy Details)
# - Region (e.g., us-ashburn-1, us-phoenix-1)
# - API Key (generate new key pair when prompted)
```

### Step 3: Generate SSH Key (if you don't have one)

```bash
# Generate SSH key pair
ssh-keygen -t rsa -b 4096 -C "your-email@example.com"

# This creates:
# ~/.ssh/id_rsa (private key - keep secret)
# ~/.ssh/id_rsa.pub (public key - safe to share)
```

### Step 4: Gather OCI Information

```bash
# Run the helper script to get your OCI details
chmod +x scripts/init/get-oci-info.sh
./scripts/init/get-oci-info.sh
```

This will show you:

- Available compartments (with automatic fallback to tenancy ID)
- Availability domains
- VCNs and subnets
- Always Free shapes (with improved error handling)
- Ubuntu images

**Note**: The script now automatically handles cases where compartments are empty by falling back to your tenancy ID.

### Step 5: Create VCN (if needed)

If you don't have a VCN and subnet, create them first:

```bash
# Create VCN and subnet automatically
chmod +x scripts/init/create-vcn.sh
./scripts/init/create-vcn.sh
```

This will create:

- Virtual Cloud Network (VCN)
- Public subnet
- Internet Gateway
- Route table
- Security list with proper rules

### Step 6: Update Configuration

The scripts now use a centralized configuration system. You can either:

**Option A: Use the configuration file (recommended)**

```bash
# Copy the template and update with your values
cp scripts/init/oci-config.env scripts/init/oci-config.local.env
# Edit oci-config.local.env with your specific values
```

**Option B: Set environment variables**

```bash
export OCI_COMPARTMENT_ID="your-compartment-ocid"
export OCI_AVAILABILITY_DOMAIN="EoFt:PHX-AD-3"
export OCI_SUBNET_ID="your-subnet-ocid"
export OCI_SSH_KEY_PATH="$HOME/.oci/your-ssh-key.pem"
export OCI_IMAGE_ID="your-image-ocid"
export OCI_SHAPE="VM.Standard.A1.Flex"
export OCI_REGION="us-phoenix-1"
export GITHUB_REPO="https://github.com/your-username/your-repo.git"
```

The scripts will automatically load configuration from the file or environment variables.

### Step 7: Create and Setup Instance

```bash
# Make the script executable
chmod +x scripts/init/create-oci-instance.sh

# Create and setup the instance (takes 5-10 minutes)
./scripts/init/create-oci-instance.sh
```

## üìã What the Script Does

### 1. **Instance Creation**

- Creates a new OCI compute instance
- Uses Always Free ARM64 shape (VM.Standard.A1.Flex)
- Configures with Ubuntu 22.04 LTS ARM64
- Assigns public IP address
- Sets up SSH access with proper JSON metadata formatting
- Validates all prerequisites before creation

### 2. **Automatic Setup**

- Installs Node.js, PostgreSQL, PM2, Nginx
- Creates database and user
- Configures firewall and security
- Sets up environment variables
- Creates application directory structure
- Prepares for CI/CD deployment

### 3. **GitHub Integration**

- Generates GitHub secrets configuration
- Provides SSH keys and connection details
- Sets up for CI/CD deployment
- Creates environment file with database credentials

## üîß Manual Steps After Script

### 1. Add GitHub Secrets

The script will generate GitHub secrets for you. Copy them to your GitHub repository:

**Repository Settings ‚Üí Secrets and Variables ‚Üí Actions**

The script will output the required secrets in this format:

```
OCI_SSH_KEY: [Your private SSH key content]
OCI_HOST: [Your instance public IP]
OCI_USER: ubuntu
APP_URL: http://[Your instance public IP]
DATABASE_URL: [Generated by setup script]
JWT_SECRET: [Generated by setup script]
```

**‚ö†Ô∏è Important:** `APP_URL` must be `http://YOUR_IP` without port or trailing slash:

- ‚úÖ Correct: `http://129.146.57.249`
- ‚ùå Wrong: `http://129.146.57.249:80` or `https://129.146.57.249`

**Note**: The actual values will be displayed when you run the script.

### 2. Test Your Application

```bash
# Check if app is running (nginx proxies port 80 to app on port 3000)
curl http://YOUR_PUBLIC_IP/api/health

# SSH into your instance
ssh ubuntu@YOUR_PUBLIC_IP

# Check application status
pm2 status
pm2 logs social-media-app

# Check nginx status
sudo systemctl status nginx
```

### 3. Deploy via CI/CD

The CI/CD pipeline uses a **tarball artifact approach** for deployment:

1. **Build Stage**: Creates optimized production build and packages it
2. **Deploy Stage**: Downloads and extracts build artifacts on OCI instance
3. **Runtime**: Installs dependencies, runs migrations, restarts application

```bash
# Push to main branch to trigger deployment
git add .
git commit -m "Deploy to production"
git push origin main
```

**What happens during deployment:**

- Tests, linting, and type checking run automatically
- Application builds with production optimizations
- Build artifacts (`.next`, `prisma`, `public`, etc.) are packaged into a tarball
- Tarball is uploaded to GitHub Actions artifacts
- Deploy job downloads and extracts the tarball on OCI
- Dependencies are installed with pnpm 10.18.3
- Database migrations run automatically
- Application restarts with PM2 using a login shell
- Internal health check (on server)
- External health check (from GitHub Actions)

**Why tarball approach?**

- Solves the hidden `.next` directory issue with GitHub Actions artifacts v4
- Preserves all file permissions and symlinks
- Faster and more reliable than copying individual files

### Useful Commands

```bash
# Check instance status
oci compute instance get --instance-id YOUR_INSTANCE_OCID

# Get instance public IP
oci compute instance list-vnics --instance-id YOUR_INSTANCE_OCID

# Stop instance (to save resources)
oci compute instance action --instance-id YOUR_INSTANCE_OCID --action STOP

# Start instance
oci compute instance action --instance-id YOUR_INSTANCE_OCID --action START
```

## üí∞ Cost Management

### Always Free Limits

- **2 VM instances** with up to 4 OCPUs total
- **24 GB RAM** total
- **200 GB block storage** total
- **No time limits** - can run 24/7
- **ARM64 shapes** (VM.Standard.A1.Flex) available in select regions

### Best Practices

- Monitor usage in OCI Console
- Keep instances active (prevents idle reclamation)
- Use monitoring to ensure app stays running
- Stop instances when not needed (data persists)

## üîí Security Notes

- SSH keys are automatically configured
- Firewall allows only HTTP (80) and HTTPS (443)
- Database is local to the instance
- Environment variables are secured
- PM2 runs as non-root user

Your social media app will be accessible at: `http://YOUR_PUBLIC_IP` (nginx proxies to port 3000)

### Additional Resources

- **Fix iptables Script**: `scripts/fix-iptables.sh` - Reorders firewall rules
- **Setup Script**: `scripts/setup-oci.sh` - Installs all dependencies with correct iptables ordering
- **Deploy Script**: `scripts/deploy-oci.sh` - Handles deployments with auto-pnpm installation
